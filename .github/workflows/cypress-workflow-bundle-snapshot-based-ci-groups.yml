name: (ciGrouped)Bundle Snapshot based E2E Cypress tests workflow for core Dashboards
on:
  pull_request:
    branches: ['**']
    paths:
      - '**/*'
      - 'cypress/**/core-opensearch-dashboards/**'
      - 'cypress/utils/dashboards/**'
  push:
    branches: ['**']
    paths:
      - 'cypress/**/core-opensearch-dashboards/**'
      - 'cypress/utils/dashboards/**'

env:
  CI_GROUPS: "1,2,3,4,5,6,7,8,9"

jobs:
  set_spec:
    runs-on: 'ubuntu-latest'
    outputs:
      spec_ciGroups: ${{ steps.get_spec.outputs.spec_ciGroups }}
    steps:
      - name: Checkout Branch
        uses: actions/checkout@v3
      - name: Checkout cypress-test
        uses: actions/checkout@v2
        with:
          repository: ${{github.repository}}
          path: spec-detect
      - id: get_spec
        name: Get specs array
        run: |
          cd spec-detect
          result="["
          IFS="," read -a groups <<< "${{ env.CI_GROUPS }}"
          for group in "${groups[@]}"; do
            IFS="," read -a SPEC_ARRAY <<< "$(npm run -s osd:ciGroup${group})"
            FORMATTED_SPEC="\\\""
            for i in "${SPEC_ARRAY[@]}"; do
              FORMATTED_SPEC+="cypress/integration/core-opensearch-dashboards/opensearch-dashboards/${i},"
            done
            FORMATTED_SPEC+="\\\""
            if [[ "${result}" != "[" ]];
            then
                result+=","
            fi
            result+="${FORMATTED_SPEC}"
          done

          result+=']';

          echo ${result}
          # echo "spec_ciGroups=${result}" >> "$GITHUB_OUTPUT"
          echo "spec_ciGroups=[\"cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/vis_builder/*.js,\",\"cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/vis_type_table/*.js,\",\"cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/vis-augmenter/*.js,\",\"cypress/integration/core-opensearch-dashboards/opensearch-dashboards/dashboard_sample_data_with_datasource_spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/dashboard_sanity_test_spec.js,\",\"cypress/integration/core-opensearch-dashboards/opensearch-dashboards/datasource-management-plugin/*.js,\",\"cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/aaa_before.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/data_source_selector.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/date_nanos_mixed.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/date_nanos.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/discover_histogram.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/discover.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/zzz_after.spec.js,\",\"cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/aaa_before.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/doc_navigation.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/doc_table.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/errors.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/field_data.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/zzz_after.spec.js,\",\"cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/aaa_before.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/field_visualize.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/filter_editor.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/index_pattern_with_encoded_id.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/index_pattern_without_field.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/zzz_after.spec.js,\",\"cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/aaa_before.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/inspector.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/large_string.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/saved_queries.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/shared_links.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/sidebar.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/source_filter.spec.js,cypress/integration/core-opensearch-dashboards/opensearch-dashboards/apps/data_explorer/zzz_after.spec.js,\"]" >> "$GITHUB_OUTPUT"

  debug:
    runs-on: 'ubuntu-latest'
    needs: ["set_spec"]
    steps:
      - name: get vars
        env:
          spec_ciGroups: ${{needs.set_spec.outputs.spec_ciGroups}}
        run: echo ${spec_ciGroups}

  tests-with-security:
    needs: ["set_spec"]
    strategy:
      fail-fast: false
      matrix:
        group: ${{ fromJSON(needs.set_spec.outputs.spec_ciGroups) }}
    uses: ./.github/workflows/release-e2e-workflow-template.yml
    with:
      test-name: Core Dashboards using Bundle Snapshot
      test-command: env CYPRESS_NO_COMMAND_LOG=1 CYPRESS_ML_COMMONS_DASHBOARDS_ENABLED=true CYPRESS_VISBUILDER_ENABLED=true CYPRESS_DATASOURCE_MANAGEMENT_ENABLED=true yarn cypress:run-with-security --browser chromium --spec '${{ matrix.group }}'
      osd-serve-args: --data_source.enabled=true --data_source.ssl.verificationMode=none --vis_builder.enabled=true --ml_commons_dashboards.enabled=true

  # tests-without-security:
  #   uses: ./.github/workflows/release-e2e-workflow-template.yml
  #   with:
  #     test-name: Core Dashboards using Bundle Snapshot
  #     test-command: env CYPRESS_NO_COMMAND_LOG=1 CYPRESS_ML_COMMONS_DASHBOARDS_ENABLED=true CYPRESS_VISBUILDER_ENABLED=true CYPRESS_DATASOURCE_MANAGEMENT_ENABLED=true yarn cypress:run-without-security --browser chromium --spec 'cypress/integration/core-opensearch-dashboards/opensearch-dashboards/**/*.js'
  #     osd-serve-args: --data_source.enabled=true --data_source.ssl.verificationMode=none --vis_builder.enabled=true --ml_commons_dashboards.enabled=true
  #     security-enabled: false
